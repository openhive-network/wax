<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proto Sign Transaction Example</title>
</head>
<body>
  <script type="module">
    // If you are not using any bundler in your project define the source map before importing @hive/wax or @hive/beekeeper (We use `parcel`. See index.ts#open)
    import * as WaxModule from '@hive/wax';
    import BeekeeperModule from '@hive/beekeeper';

    const initWasmModule = async() => {
      const module = await BeekeeperModule();
      const FS = module.FS;
      FS.mkdir(STORAGE_ROOT);
      FS.mount(FS.filesystems.IDBFS, {}, STORAGE_ROOT);
      return await new Promise((resolve, reject) => {
        FS.syncfs(true, (err) => {
          if (err)
            reject(err);

          resolve(module);
        });
      });
    }

    const sync = (fs) =>
      new Promise((resolve, reject) => {
        fs.syncfs((err) => {
          if (err) reject(err);

          resolve(null);
        });
      });

    const STORAGE_ROOT = '/storage_root';
    const WALLET_OPTIONS = ['--wallet-dir', `${STORAGE_ROOT}/.beekeeper`];

    const protoTx = WaxModule.transaction.create({
      ref_block_num: 19260,
      ref_block_prefix: 2140466769,
      expiration: "2016-09-15T19:47:33",
      operations: [
        {
          vote: {
            voter: "taoteh1221",
            author: "ozchartart",
            permlink: "usdsteem-btc-daily-poloniex-bittrex-technical-analysis-market-report-update-46-glass-half-full-but-the-bottle-s-left-empty-sept",
            weight: 10000
          }
        }
      ],
      extensions: []
    });

    const OUR_MAINNET_INITMINER_PRIVATE_KEY_DO_NOT_SHARE = "5JNHfZYKGaomSFvd4NUdQ9qMcEAC43kujbfjueTHpVapX1Kzq2n"; // :)
    const walletName = "pear";

    const handleBeekeeperJsonResult = (value) => {
      const { result } = JSON.parse(value);

      return JSON.parse(result);
    };

    (async() => {
      const waxProvider = await WaxModule.default();
      const beekeeperProvider = await initWasmModule();
      const beekeeperOptions = new beekeeperProvider.StringList();
      WALLET_OPTIONS.forEach((opt) => void beekeeperOptions.push_back(opt));

      const proto = new waxProvider.proto_protocol();
      const keeper  = new beekeeperProvider.beekeeper_api(beekeeperOptions);
      keeper.init();

      // We have to transform our API to the plain object first and then stringify it so it can be sent to wasm
      const { content: sigDigest } = proto.cpp_calculate_sig_digest(JSON.stringify(WaxModule.transaction.toJSON(protoTx)), "42");

      const { token } = handleBeekeeperJsonResult(keeper.create_session('pear'));

      keeper.create(token, walletName)
      keeper.import_key(token, walletName, OUR_MAINNET_INITMINER_PRIVATE_KEY_DO_NOT_SHARE);

      const { keys: [ { public_key: publicKey } ] } = handleBeekeeperJsonResult(keeper.get_public_keys(token));

      const { signature } = handleBeekeeperJsonResult(keeper.sign_digest(token, sigDigest, publicKey));

      console.log(`Your signature for transmitting: "${signature}"`);

      await sync(beekeeperProvider.FS);

      window.exampleFinished = true; // Optional - just for our test purposes
    })();
  </script>
</body>
</html>
